# MarketVision 数据库设计文档

## 日志架构说明

**重要**: 本系统采用混合日志架构：
- **业务数据**: 存储在 MySQL 数据库
- **操作日志**: 全部记录到 Elasticsearch，不存储在 MySQL
- **应用日志**: 通过 Logback 自动记录到 Elasticsearch

## Elasticsearch 日志索引

### 日志索引结构
- **索引名称**: `market-vision-logs-yyyy-MM-dd` (按日期分割)
- **文档类型**: `_doc`
- **主要字段**:
  - `@timestamp`: 时间戳
  - `level`: 日志级别 (INFO, DEBUG, ERROR, WARN)
  - `logger`: 日志记录器名称
  - `message`: 日志消息
  - `thread`: 线程名称
  - `application`: 应用名称 (market-vision)
  - `operationType`: 操作类型 (METHOD_CALL, METHOD_SUCCESS, METHOD_EXCEPTION)
  - `operationStatus`: 操作状态 (STARTED, SUCCESS, FAILED)
  - `operationParams`: 操作参数
  - `operationIp`: 客户端IP
  - `operationUrl`: 请求URL
  - `httpMethod`: HTTP方法

### 日志查询示例

```bash
# 查询今天的错误日志
GET /market-vision-logs-2025-01-22/_search
{
  "query": {
    "term": { "level": "ERROR" }
  }
}

# 查询特定操作类型
GET /market-vision-logs-*/_search
{
  "query": {
    "term": { "operationType": "METHOD_EXCEPTION" }
  }
}
```

## MySQL 业务表结构

### 1. 热搜记录表 (hot_search_records)

```sql
CREATE TABLE `hot_search_records` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `source` varchar(50) NOT NULL COMMENT '数据源：weibo, baidu, zhihu等',
  `title` varchar(500) NOT NULL COMMENT '热搜标题',
  `content` text COMMENT '热搜内容',
  `heat_score` int DEFAULT NULL COMMENT '热度分数',
  `sentiment_score` double DEFAULT NULL COMMENT '情感分数',
  `propagation_speed` double DEFAULT NULL COMMENT '传播速度',
  `verification_score` double DEFAULT NULL COMMENT '验证分数',
  `total_score` double DEFAULT NULL COMMENT '总分',
  `created_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_source` (`source`),
  KEY `idx_created_time` (`created_time`),
  KEY `idx_total_score` (`total_score`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='热搜记录表';
```

### 2. 热搜历史表 (hotsearch_history)

```sql
CREATE TABLE `hotsearch_history` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `keyword` varchar(200) NOT NULL COMMENT '关键词',
  `timestamp` datetime NOT NULL COMMENT '时间戳',
  `heat` int DEFAULT NULL COMMENT '热度值',
  `related_stocks` json DEFAULT NULL COMMENT '关联股票(JSON格式)',
  PRIMARY KEY (`id`),
  KEY `idx_keyword` (`keyword`),
  KEY `idx_timestamp` (`timestamp`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='热搜历史表';
```

### 3. 股票信息表 (stock_info)

```sql
CREATE TABLE `stock_info` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `stock_code` varchar(20) NOT NULL COMMENT '股票代码',
  `stock_name` varchar(100) NOT NULL COMMENT '股票名称',
  `market` varchar(10) NOT NULL COMMENT '市场：SH, SZ',
  `industry` varchar(100) DEFAULT NULL COMMENT '行业',
  `concept` json DEFAULT NULL COMMENT '概念(JSON格式)',
  `current_price` decimal(10,3) DEFAULT NULL COMMENT '当前价格',
  `market_cap` decimal(20,2) DEFAULT NULL COMMENT '市值',
  `is_active` tinyint(1) DEFAULT '1' COMMENT '是否活跃',
  `created_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_stock_code` (`stock_code`),
  KEY `idx_market` (`market`),
  KEY `idx_industry` (`industry`),
  KEY `idx_is_active` (`is_active`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='股票信息表';
```

### 4. 市场数据表 (market_data)

```sql
CREATE TABLE `market_data` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `stock_code` varchar(20) NOT NULL COMMENT '股票代码',
  `date` date NOT NULL COMMENT '交易日期',
  `industry` varchar(100) DEFAULT NULL COMMENT '行业',
  `open_price` decimal(10,3) NOT NULL COMMENT '开盘价',
  `close_price` decimal(10,3) NOT NULL COMMENT '收盘价',
  `high_price` decimal(10,3) NOT NULL COMMENT '最高价',
  `low_price` decimal(10,3) NOT NULL COMMENT '最低价',
  `volume` bigint NOT NULL COMMENT '成交量',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_stock_date` (`stock_code`, `date`),
  KEY `idx_date` (`date`),
  KEY `idx_industry` (`industry`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='市场数据表';
```

### 5. 交易记录表 (trading_records)

```sql
CREATE TABLE `trading_records` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `hot_search_id` bigint DEFAULT NULL COMMENT '关联的热搜记录ID',
  `stock_code` varchar(20) NOT NULL COMMENT '股票代码',
  `trade_type` enum('BUY','SELL') NOT NULL COMMENT '交易类型',
  `entry_price` decimal(10,3) DEFAULT NULL COMMENT '入场价格',
  `exit_price` decimal(10,3) DEFAULT NULL COMMENT '出场价格',
  `quantity` int NOT NULL COMMENT '交易数量',
  `stop_loss` decimal(10,3) DEFAULT NULL COMMENT '止损价格',
  `take_profit` decimal(10,3) DEFAULT NULL COMMENT '止盈价格',
  `profit_loss` decimal(15,3) DEFAULT NULL COMMENT '盈亏',
  `status` enum('PENDING','EXECUTED','MONITORING','CLOSED','CANCELLED') DEFAULT 'PENDING' COMMENT '交易状态',
  `entry_time` datetime DEFAULT NULL COMMENT '入场时间',
  `exit_time` datetime DEFAULT NULL COMMENT '出场时间',
  `created_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `idx_hot_search_id` (`hot_search_id`),
  KEY `idx_stock_code` (`stock_code`),
  KEY `idx_status` (`status`),
  KEY `idx_entry_time` (`entry_time`),
  CONSTRAINT `fk_trading_hot_search` FOREIGN KEY (`hot_search_id`) REFERENCES `hot_search_records` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='交易记录表';
```

### 6. 操作日志表 (operation_log)

```sql
CREATE TABLE `operation_log` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `operation_type` varchar(50) NOT NULL COMMENT '操作类型',
  `operation_description` varchar(500) DEFAULT NULL COMMENT '操作描述',
  `operation_time` datetime NOT NULL COMMENT '操作时间',
  `operation_params` text COMMENT '操作参数',
  `operation_result` text COMMENT '操作结果',
  `operation_ip` varchar(50) DEFAULT NULL COMMENT '操作IP',
  `operation_url` varchar(200) DEFAULT NULL COMMENT '操作URL',
  `http_method` varchar(10) DEFAULT NULL COMMENT 'HTTP方法',
  `operation_status` varchar(20) DEFAULT NULL COMMENT '操作状态',
  `user_id` bigint DEFAULT NULL COMMENT '用户ID',
  PRIMARY KEY (`id`),
  KEY `idx_operation_type` (`operation_type`),
  KEY `idx_operation_time` (`operation_time`),
  KEY `idx_operation_status` (`operation_status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='操作日志表';
```

### 6. 热搜生命周期日志表 (hotsearch_lifecycle_log)

```sql
CREATE TABLE `hotsearch_lifecycle_log` (
  `id` bigint NOT NULL COMMENT '雪花算法生成的主键ID',
  `hot_search_id` bigint NOT NULL COMMENT '关联的热搜记录ID',
  `lifecycle_stage` varchar(50) NOT NULL COMMENT '生命周期阶段：DISCOVERED,ANALYZING,SCORED,STOCK_MATCHED,DECISION_MADE,TRADING,MONITORING,CLOSED',
  `stage_status` varchar(20) NOT NULL COMMENT '阶段状态：STARTED,PROCESSING,SUCCESS,FAILED,SKIPPED',
  `operation_detail` varchar(1000) NOT NULL COMMENT '操作详细描述',
  `input_data` json DEFAULT NULL COMMENT '输入数据(JSON格式)',
  `output_data` json DEFAULT NULL COMMENT '输出数据(JSON格式)',
  `processing_time_ms` bigint DEFAULT NULL COMMENT '处理耗时(毫秒)',
  `error_message` text DEFAULT NULL COMMENT '错误信息',
  `error_stack` text DEFAULT NULL COMMENT '错误堆栈',
  `agent_name` varchar(100) DEFAULT NULL COMMENT '处理的智能体名称',
  `score_before` double DEFAULT NULL COMMENT '处理前分数',
  `score_after` double DEFAULT NULL COMMENT '处理后分数',
  `related_stocks` json DEFAULT NULL COMMENT '关联股票信息',
  `market_conditions` json DEFAULT NULL COMMENT '市场条件',
  `decision_factors` json DEFAULT NULL COMMENT '决策因素',
  `risk_assessment` json DEFAULT NULL COMMENT '风险评估',
  `confidence_level` double DEFAULT NULL COMMENT '置信度(0-1)',
  `created_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `created_by` varchar(100) DEFAULT 'SYSTEM' COMMENT '创建者',
  `trace_id` varchar(64) DEFAULT NULL COMMENT '链路追踪ID',
  `parent_log_id` bigint DEFAULT NULL COMMENT '父级日志ID',
  PRIMARY KEY (`id`),
  KEY `idx_hot_search_id` (`hot_search_id`),
  KEY `idx_lifecycle_stage` (`lifecycle_stage`),
  KEY `idx_stage_status` (`stage_status`),
  KEY `idx_created_time` (`created_time`),
  KEY `idx_trace_id` (`trace_id`),
  KEY `idx_parent_log_id` (`parent_log_id`),
  CONSTRAINT `fk_lifecycle_hot_search` FOREIGN KEY (`hot_search_id`) REFERENCES `hot_search_records` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='热搜生命周期详细日志表';
```

### 7. 时序数据表 (time_series_data)

```sql
CREATE TABLE `time_series_data` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `data_type` varchar(50) NOT NULL COMMENT '数据类型',
  `timestamp` datetime NOT NULL COMMENT '时间戳',
  `value` json NOT NULL COMMENT '数据值(JSON格式)',
  PRIMARY KEY (`id`),
  KEY `idx_data_type` (`data_type`),
  KEY `idx_timestamp` (`timestamp`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='时序数据表';
```

## 架构优势

1. **性能优化**: 日志写入不影响业务数据库性能
2. **存储效率**: Elasticsearch 专门优化日志存储和搜索
3. **查询能力**: 支持全文搜索、聚合分析、实时监控
4. **扩展性**: 日志数据可独立扩展，不受业务数据库限制
5. **运维友好**: 日志按日期分割，便于管理和清理

## 索引设计说明

### 主要索引策略
1. **主键索引**: 所有表都使用自增长的 `id` 作为主键
2. **唯一索引**: 
   - `stock_info.stock_code` - 确保股票代码唯一
   - `market_data(stock_code, date)` - 确保同一股票同一日期数据唯一
3. **普通索引**: 基于查询频率和业务需求创建
4. **外键约束**: `trading_records` 表关联 `hot_search_records` 表

### 查询优化考虑
- 热搜数据按时间和评分查询频繁，创建相应索引
- 股票数据按代码、市场、行业查询，创建复合索引
- 交易记录按状态、时间范围查询，优化相关索引

## 数据类型说明

- **价格字段**: 使用 `decimal(10,3)` 保证精度
- **金额字段**: 使用 `decimal(15,3)` 或 `decimal(20,2)` 
- **JSON字段**: 存储复杂结构数据，如概念、关联股票等
- **枚举字段**: 使用 `enum` 类型限制取值范围
- **时间字段**: 统一使用 `datetime` 类型

## 维护建议

1. **定期清理**: 建议定期清理过期的热搜历史和操作日志数据
2. **分区策略**: 对于大数据量表可考虑按时间分区
3. **备份策略**: 重要交易数据需要定期备份
4. **监控指标**: 监控表大小、查询性能等关键指标